<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Electoral - C.A.Q.</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #006837; 
            --light-green: #e8f5e9;
            --accent-green: #4caf50;
            --danger: #d32f2f;
            --text-dark: #333;
            --white: #ffffff;
            --grey-btn: #e0e0e0;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: var(--text-dark); }
        
        /* Header */
        header { background-color: var(--white); border-bottom: 4px solid var(--primary-green); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-placeholder { width: 50px; height: 50px; background-color: var(--light-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary-green); font-size: 20px; border: 2px solid var(--primary-green); }
        .logo-area h1 { font-size: 1.4rem; color: var(--primary-green); margin: 0; }
        .logo-area h2 { font-size: 0.85rem; color: #666; margin: 0; font-weight: 400; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .card { background: var(--white); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-header { font-size: 1.1rem; font-weight: 600; color: var(--primary-green); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* Buttons */
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 0.9rem; }
        .btn-primary { background-color: var(--primary-green); color: white; }
        .btn-primary:hover { background-color: #004d28; }
        .btn-outline { background-color: transparent; border: 2px solid var(--primary-green); color: var(--primary-green); }
        .btn-outline:hover { background-color: var(--light-green); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-clean { background-color: #78909c; color: white; }
        .btn-action { background-color: #0277bd; color: white; } 

        /* Stats Blocks */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--primary-green); color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-card.secondary { background: var(--white); color: var(--primary-green); border: 1px solid var(--primary-green); }
        .stat-number { font-size: 2rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }

        /* Voting UI */
        .voting-interface { display: flex; gap: 15px; align-items: flex-end; background: var(--light-green); padding: 20px; border-radius: 8px; border: 1px solid #c8e6c9; }
        .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .input-group label { font-size: 0.85rem; font-weight: bold; }
        .input-group input, .input-group select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }

        /* Table */
        .table-container { overflow-x: auto; min-height: 300px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: var(--text-dark); }
        .status-voted { color: var(--primary-green); font-weight: bold; }
        .status-pending { color: var(--danger); }
        tr.row-voted { background-color: rgba(76, 175, 80, 0.1); }

        /* Pagination */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .page-info { font-weight: bold; color: #555; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .modal-header { font-size: 1.2rem; font-weight: bold; color: var(--primary-green); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        .chart-box { position: relative; height: 50vh; min-height: 300px; width: 100%; margin: 0 auto; }
        .config-listas { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px; }
        .input-escrutinio { width: 70px; padding: 5px; border: 1px solid #ccc; text-align: center; }
        .escrutinio-total { font-weight: bold; background: #eee; }
        
        /* Auto Save Badge */
        #autoSaveBadge { background: #ffeb3b; color: #333; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; display: none; margin-left: 10px; }
        
        .hidden { display: none; }
        @media print { .no-print, header, .file-upload-wrapper, .voting-interface { display: none !important; } .container { max-width: 100%; } }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <div class="logo-placeholder"><i class="fas fa-balance-scale"></i></div>
        <div>
            <h1>Colegio de Abogados de Quilmes</h1>
            <h2>Sistema de Escrutinio y Control <span id="autoSaveBadge"><i class="fas fa-cloud"></i> Datos Recuperados</span></h2>
        </div>
    </div>
    <div class="no-print" style="display:flex; gap:10px;">
        <button class="btn btn-clean" onclick="limpiarTodo()"><i class="fas fa-trash"></i> Reiniciar Todo</button>
    </div>
</header>

<div class="container">

    <div class="card no-print" style="background: #f1f8e9; border: 1px solid #c5e1a5;">
        <div class="card-header" style="border:none; margin:0; padding:0;">
            <span><i class="fas fa-chart-line"></i> Panel de Control Electoral</span>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-action" onclick="abrirModalParciales()">
                    <i class="fas fa-chart-pie"></i> Resultados Parciales
                </button>
                <button class="btn btn-action" onclick="abrirModalReferentes()">
                    <i class="fas fa-users"></i> Estad√≠sticas Referentes
                </button>
                <button class="btn btn-danger" onclick="abrirModalFinal()">
                    <i class="fas fa-flag-checkered"></i> ESCRUTINIO FINAL
                </button>
            </div>
        </div>
    </div>

    <div class="card no-print" id="cardCarga">
        <div class="card-header"><i class="fas fa-file-excel"></i> Configuraci√≥n Inicial (Excel)</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <label class="btn btn-outline" style="flex:1; justify-content:center; padding:20px; border-style:dashed;">
                <i class="fas fa-users"></i> Cargar Padr√≥n Completo
                <input type="file" style="display:none" onchange="handleFile(this, 'padron')">
            </label>
            <label class="btn btn-outline" style="flex:1; justify-content:center; padding:20px; border-style:dashed;">
                <i class="fas fa-vote-yea"></i> Cargar Lista Verde
                <input type="file" style="display:none" onchange="handleFile(this, 'verdes')">
            </label>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card secondary">
            <span class="stat-number" id="statTotalPadron">0</span>
            <span class="stat-label">Padr√≥n Total</span>
        </div>
        <div class="stat-card">
            <span class="stat-number" id="statTotalVerdes">0</span>
            <span class="stat-label">Obj. Lista Verde</span>
        </div>
        <div class="stat-card secondary" style="border-color: var(--accent-green); color: var(--accent-green);">
            <span class="stat-number" id="statYaVotaron">0</span>
            <span class="stat-label">Votos Verdes (Proyecci√≥n)</span>
        </div>
        <div class="stat-card" style="background-color: var(--danger);">
            <span class="stat-number" id="statFaltan">0</span>
            <span class="stat-label">Faltan Votar</span>
        </div>
    </div>

    <div class="card no-print">
        <div class="card-header">
            <span><i class="fas fa-box-open"></i> Control de Mesa (Carga de Votantes)</span>
            <button class="btn btn-outline" onclick="toggleCorrectionMode()" id="btnCorrection">
                <i class="fas fa-edit"></i> Modo Correcci√≥n
            </button>
        </div>
        <div class="voting-interface">
            <div class="input-group">
                <label>Tomo</label>
                <select id="inputTomo"><option value="">Seleccione...</option></select>
            </div>
            <div class="input-group">
                <label>Folio</label>
                <input type="number" id="inputFolio" placeholder="Folio" onkeypress="handleEnter(event)">
            </div>
            <button class="btn btn-primary" id="btnCargarVoto" onclick="registrarVoto()">CARGAR</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header no-print">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="cambiarVista('verdes')" id="btnViewVerdes">Solo Lista Verde</button>
                <button class="btn btn-outline" onclick="cambiarVista('padron')" id="btnViewPadron">Padr√≥n Completo</button>
            </div>
            <button class="btn btn-outline" onclick="window.print()"><i class="fas fa-print"></i></button>
        </div>
        
        <div class="no-print" style="margin-bottom:15px; display:flex; gap:10px;">
            <input type="text" id="searchInput" placeholder="Buscar..." onkeyup="resetPaginacionYRender()" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
            <select id="filterReferente" onchange="resetPaginacionYRender()" style="padding:8px; border:1px solid #ccc;"><option value="">Ref: Todos</option></select>
            <select id="filterEstado" onchange="resetPaginacionYRender()" style="padding:8px; border:1px solid #ccc;"><option value="pendiente">Faltan Votar</option><option value="voto">Ya Votaron</option><option value="">Todos</option></select>
        </div>

        <div class="table-container">
            <table id="tablaVotos">
                <thead>
                    <tr><th>Estado</th><th>Tomo</th><th>Folio</th><th>Nombre</th><th>Referente(s)</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="pagination no-print">
            <button class="btn btn-outline" onclick="cambiarPagina(-1)" id="btnPrev">Anterior</button>
            <span class="page-info" id="pageInfo">P√°gina 1</span>
            <button class="btn btn-outline" onclick="cambiarPagina(1)" id="btnNext">Siguiente</button>
        </div>
    </div>

</div>

<div class="modal-overlay" id="modalParciales">
    <div class="modal-content">
        <div class="modal-header">Resultados Parciales<button class="close-modal" onclick="cerrarModal('modalParciales')">&times;</button></div>
        <div style="text-align:center;">
            <h3>Total Emitidos: <span id="parcialTotalEmitidos" style="color:blue">0</span></h3>
            <h4>Verdes (Est.): <span id="parcialVerdes" style="color:var(--primary-green)">0</span></h4>
            <div class="chart-box"><canvas id="chartParcial"></canvas></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalReferentes">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">Estad√≠stica por Referente<button class="close-modal" onclick="cerrarModal('modalReferentes')">&times;</button></div>
        <div class="table-container">
            <table id="tablaReferentes"><thead><tr><th>Referente</th><th>Total</th><th>Votaron</th><th>Faltan</th><th>% Efectividad</th></tr></thead><tbody></tbody></table>
        </div>
        <br><button class="btn btn-outline" onclick="window.print()">Imprimir</button>
    </div>
</div>

<div class="modal-overlay" id="modalFinal">
    <div class="modal-content">
        <div class="modal-header">Escrutinio Final (Matriz de Carga)<button class="close-modal" onclick="cerrarModal('modalFinal')">&times;</button></div>
        
        <div id="stepCargaFinal">
            <p style="color:#666">Defina las listas participantes y luego cargue los resultados por Tomo.</p>
            <div class="config-listas" id="configListasContainer"></div>
            <button class="btn btn-outline btn-sm" onclick="agregarConfigLista()">+ Agregar Lista Opositora</button>
            <button class="btn btn-primary btn-sm" onclick="generarTablaEscrutinio(true)">Generar Tabla de Carga</button>
            <hr>
            
            <div class="table-container" id="containerTablaEscrutinio" style="display:none;">
                <table id="tablaEscrutinio">
                    <thead></thead><tbody></tbody>
                </table>
                <br>
                <div style="background:#e8f5e9; padding:10px; text-align:right;">
                    <h3>Total General Emitidos: <span id="totalGeneralEscrutinio">0</span></h3>
                </div>
                <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="calcularResultadoFinal()">CONFIRMAR Y VER GR√ÅFICOS</button>
            </div>
        </div>

        <div id="stepResultadoFinal" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div class="chart-box"><canvas id="chartFinal"></canvas></div>
            <div id="resumenFinalTexto" style="margin:10px 0; font-weight:bold; text-align:center; font-size:1rem;"></div>
            <div style="margin-top:auto; padding-top:10px; border-top:1px solid #eee;">
                <button class="btn btn-outline" style="width:100%;" onclick="volverATabla()"><i class="fas fa-arrow-left"></i> VOLVER A LA TABLA (CORREGIR)</button>
            </div>
        </div>
    </div>
</div>

<div id="toast" style="position:fixed; bottom:20px; right:20px; background:#333; color:white; padding:15px; border-radius:5px; display:none; z-index:4000; font-weight:bold;"></div>

<script>
    // --- INICIALIZACI√ìN Y PERSISTENCIA (LOCALSTORAGE) ---
    window.onload = function() {
        Chart.register(ChartDataLabels);
        cargarEstado();
    };

    function guardarEstado() {
        try {
            const estado = {
                padronData: padronData,
                votosVerdesData: votosVerdesData,
                votosEmitidos: Array.from(votosEmitidos),
                listasConfig: listasConfig,
                tablaGenerada: tablaGenerada,
                escrutinioMatriz: recolectarMatriz()
            };
            localStorage.setItem('CAQ_Elecciones_Backup', JSON.stringify(estado));
        } catch(e) { console.error("Error guardando autoguardado", e); }
    }

    function cargarEstado() {
        const backup = localStorage.getItem('CAQ_Elecciones_Backup');
        if(backup) {
            try {
                const data = JSON.parse(backup);
                padronData = data.padronData || [];
                votosVerdesData = data.votosVerdesData || [];
                votosEmitidos = new Set(data.votosEmitidos || []);
                listasConfig = data.listasConfig || [{ id: 0, nombre: "Lista Verde", color: "#006837" }, { id: 1, nombre: "Lista Multicolor", color: "#d32f2f" }];
                tablaGenerada = data.tablaGenerada || false;
                
                if(padronData.length > 0) procesarTomos(padronData);
                if(votosVerdesData.length > 0) procesarVerdes(votosVerdesData);
                
                if(tablaGenerada) {
                    generarTablaEscrutinio(false); // False = sin pedir confirmaci√≥n
                    cargarMatriz(data.escrutinioMatriz);
                }

                if(padronData.length > 0 || votosVerdesData.length > 0) {
                    document.getElementById('autoSaveBadge').style.display = 'inline-block';
                }

                actualizarUI();
            } catch(e) { console.error("Backup corrupto", e); }
        }
    }

    // --- ESTADO GLOBAL ---
    let padronData = [];
    let votosVerdesData = [];
    let votosEmitidos = new Set(); 
    let listaTomos = new Set();
    let listaReferentes = new Set();
    let isCorrectionMode = false;
    let vistaActual = 'verdes'; 
    let tablaGenerada = false; 
    let currentPage = 1;
    const rowsPerPage = 50;
    let filteredDataCache = [];
    let chartParcialInstance = null;
    let chartFinalInstance = null;
    let listasConfig = [ { id: 0, nombre: "Lista Verde", color: "#006837" }, { id: 1, nombre: "Lista Multicolor", color: "#d32f2f" } ];

    const commonChartOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: {
            datalabels: {
                color: '#fff', font: { weight: 'bold', size: 14 },
                formatter: (value, ctx) => {
                    let sum = 0;
                    ctx.chart.data.datasets[0].data.forEach(d => sum += d);
                    return sum === 0 ? "0%" : (value*100 / sum).toFixed(1)+"%";
                }
            }, legend: { position: 'bottom' }
        }, layout: { padding: 10 }
    };

    // --- NORMALIZACI√ìN E INTELIGENCIA DE COMAS ---
    function normalizarDatos(json) {
        return json.map(row => {
            const newRow = {};
            Object.keys(row).forEach(key => {
                const k = key.toString().trim().toLowerCase();
                const val = row[key];
                if(k.match(/^(tomo|t|t\.|t¬∫)$/)) newRow.Tomo = val;
                else if(k.match(/^(folio|f|f\.|f¬∫)$/)) newRow.Folio = val;
                else if(k.includes('apellido') || k.includes('apenom')) newRow.Apellido = val;
                else if(k.includes('nombre')) newRow.Nombre = val;
                else if(k.includes('referente') || k.includes('ref') || k.includes('padrino')) newRow.Referente = val;
            });
            return { Tomo: newRow.Tomo || "?", Folio: newRow.Folio || "?", Apellido: newRow.Apellido || "", Nombre: newRow.Nombre || "", Referente: newRow.Referente || "" };
        });
    }

    // Obtener array limpio de referentes (separados por coma)
    function obtenerReferentesArray(refString) {
        if(!refString) return [];
        return refString.toString().split(',').map(r => r.trim()).filter(r => r !== "");
    }

    // --- CARGA EXCEL ---
    function handleFile(input, type) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                let json = normalizarDatos(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
                if(type === 'padron') {
                    padronData = json;
                    if(listaTomos.size === 0) procesarTomos(json);
                    showToast(`Padr√≥n: ${json.length} registros`);
                } else {
                    votosVerdesData = json;
                    procesarVerdes(json);
                    showToast(`Lista Verde: ${json.length} registros`);
                }
                actualizarUI();
                guardarEstado(); // Autoguardado
            } catch (err) { alert("Error leyendo archivo."); }
        };
        reader.readAsArrayBuffer(file);
    }

    function procesarTomos(data) {
        data.forEach(r => { if(r.Tomo !== "?") listaTomos.add(r.Tomo); });
        const sel = document.getElementById('inputTomo');
        const prev = sel.value;
        sel.innerHTML = '<option value="">Tomo</option>';
        Array.from(listaTomos).sort((a,b)=>a-b).forEach(t => sel.innerHTML += `<option value="${t}">${t}</option>`);
        sel.value = prev;
    }

    function procesarVerdes(data) {
        procesarTomos(data);
        listaReferentes.clear();
        data.forEach(r => {
            obtenerReferentesArray(r.Referente).forEach(ref => listaReferentes.add(ref));
        });
        const sel = document.getElementById('filterReferente');
        sel.innerHTML = '<option value="">Ref: Todos</option>';
        Array.from(listaReferentes).sort().forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);
    }

    // --- VOTACI√ìN ---
    function handleEnter(e) { if(e.key === 'Enter') registrarVoto(); }
    function registrarVoto() {
        const tomo = document.getElementById('inputTomo').value;
        const folio = document.getElementById('inputFolio').value;
        if(!tomo || !folio) return showToast("Faltan datos", "error");
        const key = `${tomo}-${folio}`;
        
        if(isCorrectionMode) {
            if(votosEmitidos.delete(key)) showToast("Voto Borrado", "success");
            else showToast("No exist√≠a", "error");
        } else {
            if(padronData.length > 0) {
                const habilitado = padronData.some(p => p.Tomo == tomo && p.Folio == folio);
                if(!habilitado) {
                    alert("‚õî ABOGADO NO HABILITADO PARA VOTAR\nNo figura en el Padr√≥n General.");
                    return;
                }
            }
            if(votosEmitidos.has(key)) return showToast("¬°YA VOT√ì!", "error");
            votosEmitidos.add(key);
            const esVerde = votosVerdesData.find(v => v.Tomo == tomo && v.Folio == folio);
            if(esVerde) showToast(`Verde: ${esVerde.Apellido}`, "success");
            else showToast("Registrado", "success");
        }
        document.getElementById('inputFolio').value = '';
        document.getElementById('inputFolio').focus();
        actualizarUI();
        guardarEstado(); // Autoguardado
    }
    
    function toggleCorrectionMode() {
        isCorrectionMode = !isCorrectionMode;
        const btn = document.getElementById('btnCorrection');
        const main = document.getElementById('btnCargarVoto');
        if(isCorrectionMode) {
            btn.classList.add('btn-danger'); btn.innerText = "Terminar Correcci√≥n";
            main.classList.replace('btn-primary','btn-danger'); main.innerText = "ELIMINAR";
        } else {
            btn.classList.remove('btn-danger'); btn.innerText = "Modo Correcci√≥n";
            main.classList.replace('btn-danger','btn-primary'); main.innerText = "CARGAR";
        }
    }

    // --- RENDERIZADO E INTELIGENCIA DE FILTROS ---
    function actualizarUI() {
        let totalV = votosVerdesData.length;
        let votaronV = votosVerdesData.filter(v => votosEmitidos.has(`${v.Tomo}-${v.Folio}`)).length;
        document.getElementById('statTotalPadron').innerText = padronData.length;
        document.getElementById('statTotalVerdes').innerText = totalV;
        document.getElementById('statYaVotaron').innerText = votaronV;
        document.getElementById('statFaltan').innerText = totalV - votaronV;
        resetPaginacionYRender();
    }
    function resetPaginacionYRender() { currentPage = 1; filtrarDatos(); renderTabla(); }
    
    function filtrarDatos() {
        const txt = document.getElementById('searchInput').value.toLowerCase();
        const refSelected = document.getElementById('filterReferente').value;
        const est = document.getElementById('filterEstado').value;
        let source = (vistaActual === 'padron') ? padronData : votosVerdesData;
        
        filteredDataCache = source.filter(row => {
            const key = `${row.Tomo}-${row.Folio}`;
            const yaVoto = votosEmitidos.has(key);
            if(est === 'voto' && !yaVoto) return false;
            if(est === 'pendiente' && yaVoto) return false;
            
            // Filtro Referente Inteligente (soporta m√∫ltiples separados por coma)
            if(refSelected) {
                const refsDelAbogado = obtenerReferentesArray(row.Referente);
                if(!refsDelAbogado.includes(refSelected)) return false;
            }
            
            if(txt && !`${row.Tomo} ${row.Folio} ${row.Apellido} ${row.Nombre} ${row.Referente}`.toLowerCase().includes(txt)) return false;
            return true;
        });
    }

    function renderTabla() {
        const tbody = document.querySelector('#tablaVotos tbody');
        tbody.innerHTML = '';
        const totalRows = filteredDataCache.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
        if(currentPage > totalPages) currentPage = totalPages;
        if(currentPage < 1) currentPage = 1;
        const pageData = filteredDataCache.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
        
        document.getElementById('pageInfo').innerText = `P√°gina ${currentPage} de ${totalPages}`;
        document.getElementById('btnPrev').disabled = (currentPage === 1);
        document.getElementById('btnNext').disabled = (currentPage === totalPages);

        if(totalRows === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Sin datos</td></tr>'; return; }
        pageData.forEach(row => {
            const yaVoto = votosEmitidos.has(`${row.Tomo}-${row.Folio}`);
            tbody.innerHTML += `<tr class="${yaVoto ? 'row-voted':''}">
                <td class="${yaVoto ? 'status-voted':'status-pending'}">${yaVoto ? 'VOT√ì':'PENDIENTE'}</td>
                <td>${row.Tomo}</td><td>${row.Folio}</td><td>${row.Apellido}, ${row.Nombre}</td><td>${row.Referente}</td></tr>`;
        });
    }
    function cambiarPagina(d) { currentPage += d; renderTabla(); }
    function cambiarVista(v) { 
        vistaActual = v; 
        document.getElementById('btnViewVerdes').className = v==='verdes'?'btn btn-primary':'btn btn-outline';
        document.getElementById('btnViewPadron').className = v==='padron'?'btn btn-primary':'btn btn-outline';
        document.getElementById('filterEstado').value = 'pendiente';
        resetPaginacionYRender(); 
    }

    // --- GR√ÅFICOS Y MODALES ---
    function abrirModalParciales() {
        document.getElementById('modalParciales').style.display = 'flex';
        const totalEmitidos = votosEmitidos.size;
        const verdesVotaron = votosVerdesData.filter(v => votosEmitidos.has(`${v.Tomo}-${v.Folio}`)).length;
        const otros = totalEmitidos - verdesVotaron;
        document.getElementById('parcialTotalEmitidos').innerText = totalEmitidos;
        document.getElementById('parcialVerdes').innerText = verdesVotaron;
        
        const ctx = document.getElementById('chartParcial').getContext('2d');
        if(chartParcialInstance) chartParcialInstance.destroy();
        chartParcialInstance = new Chart(ctx, { 
            type: 'pie', data: { labels: ['Verdes', 'Otros'], datasets: [{ data: [verdesVotaron, otros], backgroundColor: ['#006837', '#e0e0e0'] }] },
            options: commonChartOptions
        });
    }

    function abrirModalReferentes() {
        document.getElementById('modalReferentes').style.display = 'flex';
        const tbody = document.querySelector('#tablaReferentes tbody');
        tbody.innerHTML = '';
        let stats = [];
        
        listaReferentes.forEach(refSelected => {
            // Buscamos a los abogados que tengan a ESTE referente en su lista separada por comas
            const susVotos = votosVerdesData.filter(v => obtenerReferentesArray(v.Referente).includes(refSelected));
            const total = susVotos.length;
            const votaron = susVotos.filter(v => votosEmitidos.has(`${v.Tomo}-${v.Folio}`)).length;
            stats.push({ nombre: refSelected, total: total, votaron: votaron, faltan: total - votaron, pct: total>0?((votaron/total)*100).toFixed(1):0 });
        });

        stats.sort((a,b) => b.faltan - a.faltan);
        stats.forEach(s => { tbody.innerHTML += `<tr><td>${s.nombre}</td><td>${s.total}</td><td style="color:green; font-weight:bold">${s.votaron}</td><td style="color:red; font-weight:bold">${s.faltan}</td><td>${s.pct}%</td></tr>`; });
    }

    // --- ESCRUTINIO FINAL (MATRIZ & AUTOGUARDADO) ---
    function abrirModalFinal() {
        document.getElementById('modalFinal').style.display = 'flex';
        renderConfigListas();
    }

    function renderConfigListas() {
        const container = document.getElementById('configListasContainer');
        container.innerHTML = '';
        listasConfig.forEach((l, idx) => {
            container.innerHTML += `
                <div style="display:flex; align-items:center; gap:5px; margin-right:15px;">
                    <input type="color" value="${l.color}" onchange="updateListaConfig(${idx}, 'color', this.value)" style="width:30px; height:30px; border:none;">
                    <input type="text" value="${l.nombre}" onchange="updateListaConfig(${idx}, 'nombre', this.value)" style="padding:5px; border:1px solid #ccc; width:120px;">
                </div>
            `;
        });
    }

    function agregarConfigLista() {
        listasConfig.push({ id: Date.now(), nombre: "Nueva Lista", color: "#999999" });
        renderConfigListas();
        guardarEstado();
    }
    function updateListaConfig(idx, field, val) { 
        listasConfig[idx][field] = val; 
        guardarEstado();
    }

    function generarTablaEscrutinio(pedirConfirmacion = true) {
        if(pedirConfirmacion && tablaGenerada) {
            if(!confirm("‚ö†Ô∏è YA EXISTE UNA TABLA ACTIVA.\nSi contin√∫a, se borrar√°n todos los datos cargados en ella.\n¬øDesea reiniciar la tabla de cero?")) {
                return;
            }
        }

        const thead = document.querySelector('#tablaEscrutinio thead');
        const tbody = document.querySelector('#tablaEscrutinio tbody');
        
        let headerHTML = `<tr><th>Tomo</th>`;
        listasConfig.forEach(l => { headerHTML += `<th style="color:${l.color}">${l.nombre}</th>`; });
        headerHTML += `<th>Blancos</th><th>Nulos</th><th>TOTAL</th></tr>`;
        thead.innerHTML = headerHTML;

        tbody.innerHTML = '';
        let tomos = Array.from(listaTomos).sort((a,b)=>a-b);
        if(tomos.length === 0) tomos = [1,2,3,4,5]; 

        tomos.forEach(t => {
            let row = `<tr><td><strong>Tomo ${t}</strong></td>`;
            listasConfig.forEach((l, idx) => {
                row += `<td><input type="number" class="input-escrutinio lista-val" data-idx="${idx}" value="" onkeyup="calcRowTotal(this)" onchange="calcRowTotal(this)"></td>`;
            });
            row += `<td><input type="number" class="input-escrutinio blanco-val" value="" onkeyup="calcRowTotal(this)" onchange="calcRowTotal(this)"></td>`;
            row += `<td><input type="number" class="input-escrutinio nulo-val" value="" onkeyup="calcRowTotal(this)" onchange="calcRowTotal(this)"></td>`;
            row += `<td class="escrutinio-total row-total">0</td></tr>`;
            tbody.innerHTML += row;
        });

        document.getElementById('containerTablaEscrutinio').style.display = 'block';
        tablaGenerada = true; 
        if(pedirConfirmacion) guardarEstado(); 
    }

    function calcRowTotal(input) {
        const row = input.closest('tr');
        let total = 0;
        row.querySelectorAll('input').forEach(inp => total += (parseInt(inp.value)||0));
        row.querySelector('.row-total').innerText = total;
        
        let grandTotal = 0;
        document.querySelectorAll('.row-total').forEach(td => grandTotal += parseInt(td.innerText));
        document.getElementById('totalGeneralEscrutinio').innerText = grandTotal;
        guardarEstado(); // Autoguardado al tipear en la matriz
    }

    function recolectarMatriz() {
        if(!tablaGenerada) return null;
        let datos = [];
        document.querySelectorAll('#tablaEscrutinio tbody tr').forEach(tr => {
            let fila = [];
            tr.querySelectorAll('input').forEach(inp => fila.push(inp.value));
            datos.push(fila);
        });
        return datos;
    }

    function cargarMatriz(datos) {
        if(!datos) return;
        document.querySelectorAll('#tablaEscrutinio tbody tr').forEach((tr, i) => {
            if(datos[i]) {
                let inps = tr.querySelectorAll('input');
                datos[i].forEach((val, j) => { if(inps[j]) inps[j].value = val; });
                calcRowTotal(inps[0]); // Trigger sums
            }
        });
    }

    function calcularResultadoFinal() {
        let totalesListas = new Array(listasConfig.length).fill(0);
        let totalBlancos = 0;
        let totalNulos = 0;

        document.querySelectorAll('#tablaEscrutinio tbody tr').forEach(tr => {
            tr.querySelectorAll('.lista-val').forEach(inp => { totalesListas[parseInt(inp.dataset.idx)] += (parseInt(inp.value)||0); });
            totalBlancos += (parseInt(tr.querySelector('.blanco-val').value)||0);
            totalNulos += (parseInt(tr.querySelector('.nulo-val').value)||0);
        });

        let totalGeneral = totalesListas.reduce((a,b)=>a+b, 0) + totalBlancos + totalNulos;

        document.getElementById('stepCargaFinal').classList.add('hidden');
        document.getElementById('stepResultadoFinal').classList.remove('hidden'); 

        const labels = [...listasConfig.map(l => l.nombre), "Blancos", "Nulos"];
        const data = [...totalesListas, totalBlancos, totalNulos];
        const colors = [...listasConfig.map(l => l.color), "#cccccc", "#666666"];

        const ctx = document.getElementById('chartFinal').getContext('2d');
        if(chartFinalInstance) chartFinalInstance.destroy();

        chartFinalInstance = new Chart(ctx, {
            type: 'pie',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: colors }] },
            options: commonChartOptions
        });

        let html = `Total Votos Escrutados: ${totalGeneral}<br>`;
        labels.forEach((l, i) => {
            let pct = totalGeneral > 0 ? ((data[i]/totalGeneral)*100).toFixed(2) : 0;
            html += `${l}: ${data[i]} (${pct}%)<br>`;
        });
        document.getElementById('resumenFinalTexto').innerHTML = html;
    }

    function volverATabla() {
        document.getElementById('stepResultadoFinal').classList.add('hidden');
        document.getElementById('stepCargaFinal').classList.remove('hidden');
    }

    function cerrarModal(id) { document.getElementById(id).style.display='none'; }
    function showToast(msg, type="success") { const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; t.style.background=type==="error"?"#d32f2f":"#333"; setTimeout(()=>t.style.display='none',3000); }
    
    function limpiarTodo() { 
        if(confirm("üõë ¬øEST√Å SEGURO QUE DESEA BORRAR TODO EL SISTEMA?\nSe eliminar√°n los Excel cargados y todos los votos.\nEsta acci√≥n NO se puede deshacer.")) { 
            localStorage.removeItem('CAQ_Elecciones_Backup');
            location.reload(); 
        } 
    }
</script>
</body>
</html>
